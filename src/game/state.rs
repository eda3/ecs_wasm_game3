//! ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
//! 
//! ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’ç®¡ç†ã—ã€çŠ¶æ…‹é·ç§»ã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚
//! ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚²ãƒ¼ãƒ å…¨ä½“ã®ã€ŒçŠ¶æ…‹ã€ã‚’åˆ¶å¾¡ã™ã‚‹ä¸­å¿ƒçš„ãªå½¹å‰²ã‚’æŒã¡ã¾ã™ã€‚
//! ã€ŒçŠ¶æ…‹ã€ã¨ã¯ã€ã‚²ãƒ¼ãƒ ãŒä»Šã©ã®ã‚ˆã†ãªå ´é¢ï¼ˆã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€
//! å®Ÿéš›ã®ãƒ—ãƒ¬ã‚¤ä¸­ãªã©ï¼‰ã«ã‚ã‚‹ã‹ã‚’è¡¨ã—ã¾ã™ã€‚

use wasm_bindgen::prelude::*;
use web_sys::HtmlCanvasElement;
use log;

/// ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’è¡¨ã™åˆ—æŒ™å‹
/// 
/// ã‚²ãƒ¼ãƒ ã«ã¯è¤‡æ•°ã®çŠ¶æ…‹ãŒã‚ã‚Šã€å„çŠ¶æ…‹ã”ã¨ã«ç•°ãªã‚‹å‡¦ç†ï¼ˆæç”»ãƒ»æ“ä½œï¼‰ãŒè¡Œã‚ã‚Œã¾ã™ã€‚
/// ä¾‹ãˆã°ã€ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§ã¯ã‚«ãƒ¼ãƒ‰é¸æŠã‚„ãƒ‡ãƒƒã‚­æ§‹ç¯‰ã‚’è¡Œã„ã€
/// Playingï¼ˆãƒ—ãƒ¬ã‚¤ä¸­ï¼‰çŠ¶æ…‹ã§ã¯ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã—ãŸã‚Šå¯¾æˆ¦ã—ãŸã‚Šã—ã¾ã™ã€‚
#[derive(Debug, Clone, Copy, PartialEq, Eq)]
pub enum GameStateType {
    /// ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢
    /// ã‚²ãƒ¼ãƒ èµ·å‹•æ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹åˆæœŸç”»é¢ã§ã™
    Splash,
    /// ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼
    /// ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰é¸æŠã‚„ãƒ‡ãƒƒã‚­ç·¨é›†ãªã©ã‚’è¡Œã†ç”»é¢ã§ã™
    MainMenu,
    /// ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ä¸­
    /// å®Ÿéš›ã«ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ã™
    Playing,
    /// ãƒãƒ¼ã‚ºä¸­
    /// ã‚²ãƒ¼ãƒ ã‚’ä¸€æ™‚åœæ­¢ã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ã™
    Paused,
    /// ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
    /// ã‚²ãƒ¼ãƒ ãŒçµ‚äº†ã—ãŸçŠ¶æ…‹ã§ã™ï¼ˆå‹æ•—ãŒæ±ºã¾ã£ãŸå¾Œãªã©ï¼‰
    GameOver,
}

/// ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹æ§‹é€ ä½“
/// 
/// ã“ã®æ§‹é€ ä½“ã¯ç¾åœ¨ã®ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã¨æç”»ã«å¿…è¦ãªæƒ…å ±ã‚’ä¿æŒã—ã¾ã™ã€‚
/// çŠ¶æ…‹ã«å¿œã˜ãŸæ›´æ–°å‡¦ç†ã‚„æç”»å‡¦ç†ã‚’è¡Œã†ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æä¾›ã—ã¾ã™ã€‚
pub struct GameState {
    /// ç¾åœ¨ã®ã‚²ãƒ¼ãƒ çŠ¶æ…‹
    /// GameStateTypeã®ã„ãšã‚Œã‹ã®å€¤ãŒå…¥ã‚Šã¾ã™
    current_state: GameStateType,
    /// æç”»å…ˆã®ã‚­ãƒ£ãƒ³ãƒã‚¹
    /// Webãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§æç”»ã‚’è¡Œã†ãŸã‚ã®HTMLè¦ç´ ã§ã™
    canvas: HtmlCanvasElement,
    /// 2Dæç”»ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
    /// ã‚­ãƒ£ãƒ³ãƒã‚¹ã«å¯¾ã—ã¦å›³å½¢ã‚„ãƒ†ã‚­ã‚¹ãƒˆã‚’æç”»ã™ã‚‹ãŸã‚ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™
    context: web_sys::CanvasRenderingContext2d,
}

impl GameState {
    /// æ–°ã—ã„ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ä½œæˆã—ã¾ã™ã€‚
    /// 
    /// # å¼•æ•°
    /// 
    /// * `canvas` - ã‚²ãƒ¼ãƒ ã®æç”»å…ˆã‚­ãƒ£ãƒ³ãƒã‚¹
    /// 
    /// # æˆ»ã‚Šå€¤
    /// 
    /// åˆæœŸåŒ–ã•ã‚ŒãŸGameStateã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€ã¾ãŸã¯åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼
    /// 
    /// # è©³ç´°
    /// 
    /// ã“ã®é–¢æ•°ã¯ã‚²ãƒ¼ãƒ èµ·å‹•æ™‚ã«å‘¼ã³å‡ºã•ã‚Œã€æç”»ç’°å¢ƒã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚
    /// æœ€åˆã®çŠ¶æ…‹ã¯ã€Œã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢ã€ã«è¨­å®šã•ã‚Œã¾ã™ã€‚
    pub fn new(canvas: HtmlCanvasElement) -> Result<Self, JsValue> {
        // ã‚­ãƒ£ãƒ³ãƒã‚¹æƒ…å ±ã‚’ãƒ­ã‚°å‡ºåŠ›
        log::info!("ğŸ–¼ï¸ GameState::new() - ã‚­ãƒ£ãƒ³ãƒã‚¹ID: {}, ã‚µã‚¤ã‚º: {}x{}", 
                   canvas.id(), canvas.width(), canvas.height());
        
        // 2Dæç”»ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å–å¾—
        // ã“ã‚Œã«ã‚ˆã‚Šã‚­ãƒ£ãƒ³ãƒã‚¹ã«å›³å½¢ã‚„ãƒ†ã‚­ã‚¹ãƒˆã‚’æç”»ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™
        let context = canvas
            .get_context("2d")?  // 2Dã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ï¼ˆå¤±æ•—ã—ãŸã‚‰?ã§ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ï¼‰
            .unwrap()            // Optionã‚’ã‚¢ãƒ³ãƒ©ãƒƒãƒ—ï¼ˆNoneã®å ´åˆã¯ãƒ‘ãƒ‹ãƒƒã‚¯ï¼‰
            .dyn_into::<web_sys::CanvasRenderingContext2d>()?;  // é©åˆ‡ãªå‹ã«å¤‰æ›
        
        log::info!("âœ… 2Dæç”»ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå–å¾—æˆåŠŸ");

        // åˆæœŸçŠ¶æ…‹ã§ã¯ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢ã‹ã‚‰å§‹ã¾ã‚Šã¾ã™
        Ok(Self {
            current_state: GameStateType::Splash,
            canvas,
            context,
        })
    }

    /// ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¾ã™ã€‚
    /// 
    /// # å¼•æ•°
    /// 
    /// * `delta_time` - å‰ãƒ•ãƒ¬ãƒ¼ãƒ ã‹ã‚‰ã®çµŒéæ™‚é–“ï¼ˆç§’ï¼‰
    /// 
    /// # è©³ç´°
    /// 
    /// ã“ã®é–¢æ•°ã¯ã‚²ãƒ¼ãƒ ã®å„ãƒ•ãƒ¬ãƒ¼ãƒ ã§å‘¼ã³å‡ºã•ã‚Œã€ç¾åœ¨ã®çŠ¶æ…‹ã«å¿œã˜ãŸ
    /// æ›´æ–°å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚ä¾‹ãˆã°ã€ã‚«ãƒ¼ãƒ‰ã®ç§»å‹•ã‚„ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°ãªã©ã§ã™ã€‚
    /// delta_timeã‚’ä½¿ã†ã“ã¨ã§ã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆãŒå¤‰ã‚ã£ã¦ã‚‚ä¸€å®šã®é€Ÿåº¦ã§
    /// ã‚²ãƒ¼ãƒ ãŒé€²è¡Œã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
    pub fn update(&mut self, delta_time: f32) -> Result<(), JsValue> {
        // ç¾åœ¨ã®çŠ¶æ…‹ã«å¿œã˜ãŸæ›´æ–°å‡¦ç†ã‚’å‘¼ã³å‡ºã—ã¾ã™
        match self.current_state {
            GameStateType::Splash => self.update_splash(delta_time),
            GameStateType::MainMenu => self.update_main_menu(delta_time),
            GameStateType::Playing => self.update_playing(delta_time),
            GameStateType::Paused => self.update_paused(delta_time),
            GameStateType::GameOver => self.update_game_over(delta_time),
        }
    }

    /// ã‚²ãƒ¼ãƒ ã‚’æç”»ã—ã¾ã™ã€‚
    /// 
    /// # è©³ç´°
    /// 
    /// ã“ã®é–¢æ•°ã¯ã‚²ãƒ¼ãƒ ã®å„ãƒ•ãƒ¬ãƒ¼ãƒ ã§å‘¼ã³å‡ºã•ã‚Œã€ç¾åœ¨ã®çŠ¶æ…‹ã«å¿œã˜ãŸ
    /// æç”»å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ã‚²ãƒ¼ãƒ ç”»é¢ãªã©ã€
    /// çŠ¶æ…‹ã«ã‚ˆã£ã¦å…¨ãç•°ãªã‚‹è¦‹ãŸç›®ã‚’æç”»ã—ã¾ã™ã€‚
    pub fn render(&self) -> Result<(), JsValue> {
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®çŠ¶æ…‹ã‚’ãƒ­ã‚°å‡ºåŠ›
        log::info!("ğŸ–¼ï¸ render()é–‹å§‹: ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚º {}x{}", 
                   self.canvas.width(), self.canvas.height());

        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢ï¼ˆå‰ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã®æç”»å†…å®¹ã‚’æ¶ˆå»ï¼‰
        self.context.clear_rect(
            0.0,  // å·¦ä¸ŠXåº§æ¨™
            0.0,  // å·¦ä¸ŠYåº§æ¨™
            self.canvas.width() as f64,   // å¹…
            self.canvas.height() as f64,  // é«˜ã•
        );

        // ç¾åœ¨ã®çŠ¶æ…‹ã«å¿œã˜ãŸæç”»å‡¦ç†ã‚’å‘¼ã³å‡ºã™
        let result = match self.current_state {
            GameStateType::Splash => {
                log::info!("ğŸ¬ ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–‹å§‹");
                self.render_splash()
            },
            GameStateType::MainMenu => {
                log::info!("ğŸ“‹ ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–‹å§‹");
                self.render_main_menu()
            },
            GameStateType::Playing => {
                log::info!("ğŸ® ãƒ—ãƒ¬ã‚¤ä¸­ç”»é¢ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–‹å§‹");
                self.render_playing()
            },
            GameStateType::Paused => {
                log::info!("â¸ï¸ ãƒãƒ¼ã‚ºç”»é¢ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–‹å§‹");
                self.render_paused()
            },
            GameStateType::GameOver => {
                log::info!("ğŸ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–‹å§‹");
                self.render_game_over()
            },
        };
        
        log::info!("âœ… render()å®Œäº†: çŠ¶æ…‹={:?}", self.current_state);
        result
    }

    /// ã‚­ãƒ¼å…¥åŠ›ã‚’å‡¦ç†ã—ã¾ã™ã€‚
    /// 
    /// # å¼•æ•°
    /// 
    /// * `key_code` - ã‚­ãƒ¼ã‚³ãƒ¼ãƒ‰ï¼ˆã©ã®ã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸã‹ï¼‰
    /// * `pressed` - ã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸã‹ã©ã†ã‹ï¼ˆtrue=æŠ¼ã•ã‚ŒãŸã€false=é›¢ã•ã‚ŒãŸï¼‰
    /// 
    /// # è©³ç´°
    /// 
    /// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›ã‚’å‡¦ç†ã—ã¾ã™ã€‚ä¾‹ãˆã°ï¼š
    /// - ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§ã®é¸æŠç§»å‹•ï¼ˆçŸ¢å°ã‚­ãƒ¼ï¼‰
    /// - ã‚«ãƒ¼ãƒ‰ã®é¸æŠã‚„ç¢ºå®šï¼ˆã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼ï¼‰
    /// - ãƒãƒ¼ã‚º/å†é–‹ï¼ˆESCã‚­ãƒ¼ï¼‰
    /// 
    /// ç¾åœ¨ã®çŠ¶æ…‹ã«ã‚ˆã£ã¦ã€åŒã˜ã‚­ãƒ¼å…¥åŠ›ã§ã‚‚ç•°ãªã‚‹å‡¦ç†ãŒè¡Œã‚ã‚Œã¾ã™ã€‚
    pub fn handle_key_input(&mut self, key_code: u32, pressed: bool) -> Result<(), JsValue> {
        // ã‚­ãƒ¼ãŒé›¢ã•ã‚ŒãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆæŠ¼ã•ã‚ŒãŸã¨ãã ã‘å‡¦ç†ï¼‰
        if !pressed {
            return Ok(());
        }

        // ç¾åœ¨ã®çŠ¶æ…‹ã«å¿œã˜ãŸã‚­ãƒ¼å‡¦ç†ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™
        match self.current_state {
            GameStateType::Splash => self.handle_splash_key(key_code),
            GameStateType::MainMenu => self.handle_main_menu_key(key_code),
            GameStateType::Playing => self.handle_playing_key(key_code),
            GameStateType::Paused => self.handle_paused_key(key_code),
            GameStateType::GameOver => self.handle_game_over_key(key_code),
        }
    }

    /// ãƒã‚¦ã‚¹å…¥åŠ›ã‚’å‡¦ç†ã—ã¾ã™ã€‚
    /// 
    /// # å¼•æ•°
    /// 
    /// * `x` - ãƒã‚¦ã‚¹ã®Xåº§æ¨™ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹å†…ã®ä½ç½®ï¼‰
    /// * `y` - ãƒã‚¦ã‚¹ã®Yåº§æ¨™ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹å†…ã®ä½ç½®ï¼‰
    /// * `button` - ãƒã‚¦ã‚¹ãƒœã‚¿ãƒ³ï¼ˆ0=å·¦ã€1=ä¸­ã€2=å³ï¼‰
    /// * `pressed` - ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‹ã©ã†ã‹
    /// 
    /// # è©³ç´°
    /// 
    /// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒã‚¦ã‚¹å…¥åŠ›ã‚’å‡¦ç†ã—ã¾ã™ã€‚ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ã§ã¯ç‰¹ã«é‡è¦ã§ï¼š
    /// - ã‚«ãƒ¼ãƒ‰ã®é¸æŠï¼ˆã‚¯ãƒªãƒƒã‚¯ï¼‰
    /// - ã‚«ãƒ¼ãƒ‰ã®ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—
    /// - ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®é¸æŠ
    /// ãªã©ã®æ“ä½œã«ä½¿ã‚ã‚Œã¾ã™ã€‚
    pub fn handle_mouse_input(&mut self, x: f32, y: f32, button: u8, pressed: bool) -> Result<(), JsValue> {
        // ãƒœã‚¿ãƒ³ãŒé›¢ã•ã‚ŒãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆæŠ¼ã•ã‚ŒãŸã¨ãã ã‘å‡¦ç†ï¼‰
        if !pressed {
            return Ok(());
        }

        // ç¾åœ¨ã®çŠ¶æ…‹ã«å¿œã˜ãŸãƒã‚¦ã‚¹å‡¦ç†ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™
        match self.current_state {
            GameStateType::Splash => self.handle_splash_mouse(x, y, button),
            GameStateType::MainMenu => self.handle_main_menu_mouse(x, y, button),
            GameStateType::Playing => self.handle_playing_mouse(x, y, button),
            GameStateType::Paused => self.handle_paused_mouse(x, y, button),
            GameStateType::GameOver => self.handle_game_over_mouse(x, y, button),
        }
    }

    // å„çŠ¶æ…‹ã®æ›´æ–°å‡¦ç†
    // -----------------
    
    /// ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢ã®æ›´æ–°å‡¦ç†
    /// 
    /// ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢ã§ã¯ã€é€šå¸¸ã¯æ™‚é–“çµŒéã‚„ã‚­ãƒ¼å…¥åŠ›ã«å¿œã˜ã¦
    /// ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ç§»è¡Œã™ã‚‹å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚
    /// ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹å ´åˆã¯ã“ã“ã§æ›´æ–°ã—ã¾ã™ã€‚
    fn update_splash(&mut self, _delta_time: f32) -> Result<(), JsValue> {
        // TODO: ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢ã®æ›´æ–°å‡¦ç†
        // ä¾‹: ä¸€å®šæ™‚é–“çµŒéå¾Œã«ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ç§»è¡Œ
        // if self.splash_timer > 3.0 {
        //     self.current_state = GameStateType::MainMenu;
        // }
        Ok(())
    }

    /// ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®æ›´æ–°å‡¦ç†
    /// 
    /// ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ã€é¸æŠã‚«ãƒ¼ã‚½ãƒ«ã®ç‚¹æ»…ãªã©ã‚’
    /// æ›´æ–°ã™ã‚‹å‡¦ç†ã‚’ã“ã“ã«æ›¸ãã¾ã™ã€‚
    fn update_main_menu(&mut self, _delta_time: f32) -> Result<(), JsValue> {
        // TODO: ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®æ›´æ–°å‡¦ç†
        // ä¾‹: ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
        Ok(())
    }

    /// ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ä¸­ã®æ›´æ–°å‡¦ç†
    /// 
    /// ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ã®å®Ÿéš›ã®ãƒ—ãƒ¬ã‚¤ä¸­ã«è¡Œã‚ã‚Œã‚‹æ›´æ–°å‡¦ç†ã§ã™ã€‚
    /// - ã‚«ãƒ¼ãƒ‰ã®ç§»å‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    /// - åŠ¹æœã®ç™ºå‹•
    /// - ç›¸æ‰‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡Œå‹•
    /// - ã‚¿ãƒ¼ãƒ³çµŒé
    /// ãªã©ã‚’å‡¦ç†ã—ã¾ã™ã€‚
    fn update_playing(&mut self, _delta_time: f32) -> Result<(), JsValue> {
        // TODO: ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ä¸­ã®æ›´æ–°å‡¦ç†
        // ä¾‹: ã‚«ãƒ¼ãƒ‰ã®ç§»å‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
        // for card in self.cards.iter_mut() {
        //     card.update_position(delta_time);
        // }
        Ok(())
    }

    /// ãƒãƒ¼ã‚ºä¸­ã®æ›´æ–°å‡¦ç†
    /// 
    /// ã‚²ãƒ¼ãƒ ãŒä¸€æ™‚åœæ­¢ã—ã¦ã„ã‚‹é–“ã®å‡¦ç†ã§ã™ã€‚
    /// é€šå¸¸ã¯ã‚ã¾ã‚Šå‡¦ç†ã‚’è¡Œã„ã¾ã›ã‚“ãŒã€ãƒãƒ¼ã‚ºãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®
    /// ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã©ã¯ã“ã“ã§æ›´æ–°ã—ã¾ã™ã€‚
    fn update_paused(&mut self, _delta_time: f32) -> Result<(), JsValue> {
        // TODO: ãƒãƒ¼ã‚ºä¸­ã®æ›´æ–°å‡¦ç†
        // ãƒãƒ¼ã‚ºä¸­ã¯åŸºæœ¬çš„ã«ã‚²ãƒ¼ãƒ ã®é€²è¡Œã‚’æ­¢ã‚ã‚‹ã®ã§
        // æœ€å°é™ã®å‡¦ç†ã ã‘ã‚’è¡Œã„ã¾ã™
        Ok(())
    }

    /// ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚ã®æ›´æ–°å‡¦ç†
    /// 
    /// ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ï¼ˆå‹æ•—æ±ºå®šå¾Œï¼‰ã®å‡¦ç†ã§ã™ã€‚
    /// ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚„çµæœç”»é¢ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã©ã‚’
    /// æ›´æ–°ã™ã‚‹å‡¦ç†ã‚’ã“ã“ã«æ›¸ãã¾ã™ã€‚
    fn update_game_over(&mut self, _delta_time: f32) -> Result<(), JsValue> {
        // TODO: ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã®æ›´æ–°å‡¦ç†
        // ä¾‹: çµæœç™ºè¡¨ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        // self.result_animation.update(delta_time);
        Ok(())
    }

    // å„çŠ¶æ…‹ã®æç”»å‡¦ç†
    // ---------------
    
    /// ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢ã®æç”»å‡¦ç†
    /// 
    /// ã‚²ãƒ¼ãƒ èµ·å‹•æ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢ï¼ˆãƒ­ã‚´ãªã©ï¼‰ã‚’æç”»ã—ã¾ã™ã€‚
    fn render_splash(&self) -> Result<(), JsValue> {
        log::info!("ğŸ” render_splash: æç”»å‡¦ç†é–‹å§‹");
        
        // èƒŒæ™¯ã‚’é»’ã§å¡—ã‚Šã¤ã¶ã™
        self.context.set_fill_style_str("#000000");  // é»’è‰²ã‚’è¨­å®š
        self.context.fill_rect(
            0.0,  // å·¦ä¸ŠXåº§æ¨™
            0.0,  // å·¦ä¸ŠYåº§æ¨™
            self.canvas.width() as f64,   // å¹…
            self.canvas.height() as f64,  // é«˜ã•
        );
        log::info!("âœ“ èƒŒæ™¯ã‚’é»’ã§å¡—ã‚Šã¤ã¶ã—å®Œäº†");
        
        // ã“ã“ã«ãƒ­ã‚´ã‚„é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æç”»å‡¦ç†ã‚’è¿½åŠ 

        // ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¡¨ç¤º
        self.context.set_font("40px Arial");
        self.context.set_fill_style_str("#FFFFFF");  // ç™½è‰²ãƒ†ã‚­ã‚¹ãƒˆ
        self.context.set_text_align("center");
        self.context.set_text_baseline("middle");
        
        // ç”»é¢ä¸­å¤®ã«ã‚¿ã‚¤ãƒˆãƒ«ã‚’æç”»
        let _ = self.context.fill_text(
            "ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ",  // ã‚²ãƒ¼ãƒ ã‚¿ã‚¤ãƒˆãƒ«
            (self.canvas.width() / 2) as f64,  // Xåº§æ¨™ï¼ˆä¸­å¤®ï¼‰
            (self.canvas.height() / 2) as f64,  // Yåº§æ¨™ï¼ˆä¸­å¤®ï¼‰
        );
        
        // ã€ŒPress Any Keyã€ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        self.context.set_font("20px Arial");
        let _ = self.context.fill_text(
            "Press Any Key to Start",
            (self.canvas.width() / 2) as f64,
            (self.canvas.height() / 2 + 50) as f64,  // ã‚¿ã‚¤ãƒˆãƒ«ã®ä¸‹ã«è¡¨ç¤º
        );
        
        log::info!("âœ“ ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢ã®æç”»å®Œäº†");
        Ok(())
    }

    /// ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã®æç”»å‡¦ç†
    /// 
    /// ã‚²ãƒ¼ãƒ ã®ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒ¢ãƒ¼ãƒ‰é¸æŠã€ãƒ‡ãƒƒã‚­ç·¨é›†ãªã©ï¼‰ã‚’æç”»ã—ã¾ã™ã€‚
    /// ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã‚„ãƒœã‚¿ãƒ³ã€èƒŒæ™¯ãªã©ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
    fn render_main_menu(&self) -> Result<(), JsValue> {
        // èƒŒæ™¯è‰²ã‚’è¨­å®šï¼ˆæ¿ƒã„é’ï¼‰
        self.context.set_fill_style_str("#001133");
        self.context.fill_rect(
            0.0,
            0.0,
            self.canvas.width() as f64,
            self.canvas.height() as f64,
        );
        
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«ã‚’æç”»
        self.context.set_font("32px Arial");
        self.context.set_fill_style_str("#FFFFFF");
        self.context.set_text_align("center");
        let _ = self.context.fill_text(
            "ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼",
            (self.canvas.width() / 2) as f64,
            50.0,
        );
        
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã‚’æç”»
        self.context.set_font("24px Arial");
        
        // ã“ã®éƒ¨åˆ†ã¯å®Ÿéš›ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã‚’è¡¨ç¤ºã™ã‚‹
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã¯ãƒœã‚¿ãƒ³ã‚„é¸æŠå¯èƒ½ãªãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹
        let menu_items = [
            "ãƒ—ãƒ¬ã‚¤é–‹å§‹",
            "ãƒ‡ãƒƒã‚­ç·¨é›†",
            "ã‚ªãƒ—ã‚·ãƒ§ãƒ³",
            "ãƒ«ãƒ¼ãƒ«èª¬æ˜",
            "çµ‚äº†"
        ];
        
        for (i, item) in menu_items.iter().enumerate() {
            let y = 150.0 + (i as f64) * 50.0;
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®èƒŒæ™¯ï¼ˆé¸æŠä¸­ã®é …ç›®ã¯å¼·èª¿è¡¨ç¤ºï¼‰
            // self.context.set_fill_style_str(if i == self.selected_menu_index { "#3355AA" } else { "#223366" });
            self.context.set_fill_style_str("#223366");  // é€šå¸¸ã®é …ç›®ã®èƒŒæ™¯è‰²
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®èƒŒæ™¯ã‚’æç”»
            self.context.fill_rect(
                (self.canvas.width() as f64 / 2.0) - 150.0,
                y - 20.0,
                300.0,
                40.0,
            );
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æç”»
            self.context.set_fill_style_str("#FFFFFF");
            let _ = self.context.fill_text(
                item,
                (self.canvas.width() / 2) as f64,
                y,
            );
        }
        
        // æ“ä½œæ–¹æ³•ã®ãƒ˜ãƒ«ãƒ—ãƒ†ã‚­ã‚¹ãƒˆ
        self.context.set_font("16px Arial");
        self.context.set_fill_style_str("#AAAAAA");
        let _ = self.context.fill_text(
            "â†‘â†“: é¸æŠ  Enter: æ±ºå®š  Esc: æˆ»ã‚‹",
            (self.canvas.width() / 2) as f64,
            (self.canvas.height() - 30) as f64,
        );
        
        Ok(())
    }

    /// ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ä¸­ã®æç”»å‡¦ç†
    /// 
    /// ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ã®ãƒ¡ã‚¤ãƒ³ç”»é¢ã‚’æç”»ã—ã¾ã™ã€‚
    /// - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹æœ­
    /// - å ´ã®ã‚«ãƒ¼ãƒ‰
    /// - ç›¸æ‰‹ã®æƒ…å ±
    /// - ã‚²ãƒ¼ãƒ çŠ¶æ…‹ï¼ˆãƒ©ã‚¤ãƒ•ã€ã‚¿ãƒ¼ãƒ³æ•°ãªã©ï¼‰
    /// ãªã©ã‚’æç”»ã—ã¾ã™ã€‚
    fn render_playing(&self) -> Result<(), JsValue> {
        // èƒŒæ™¯è‰²ã‚’è¨­å®šï¼ˆç·‘ã®ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
        self.context.set_fill_style_str("#006622");
        self.context.fill_rect(
            0.0,
            0.0,
            self.canvas.width() as f64,
            self.canvas.height() as f64,
        );
        
        // ã‚²ãƒ¼ãƒ æƒ…å ±è¡¨ç¤ºï¼ˆã‚¿ãƒ¼ãƒ³ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åãªã©ï¼‰
        self.context.set_font("18px Arial");
        self.context.set_fill_style_str("#FFFFFF");
        self.context.set_text_align("left");
        let _ = self.context.fill_text(
            "ã‚¿ãƒ¼ãƒ³: 1 / ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®ç•ª",
            20.0,
            30.0,
        );
        
        // ã‚¹ã‚³ã‚¢ï¼ãƒ©ã‚¤ãƒ•è¡¨ç¤º
        self.context.set_text_align("right");
        let _ = self.context.fill_text(
            "ãƒ©ã‚¤ãƒ•: 20 / 20",
            (self.canvas.width() - 20) as f64,
            30.0,
        );
        
        // ãƒ—ãƒ¬ã‚¤ã‚¨ãƒªã‚¢ã®å¢ƒç•Œç·š
        self.context.set_stroke_style_str("#FFFFFF");
        self.context.set_line_width(2.0);
        self.context.begin_path();
        self.context.move_to(0.0, (self.canvas.height() / 2) as f64);
        self.context.line_to(self.canvas.width() as f64, (self.canvas.height() / 2) as f64);
        self.context.stroke();
        
        // ç›¸æ‰‹ã®ã‚«ãƒ¼ãƒ‰ï¼ˆè£å‘ãï¼‰ã‚’æç”»
        // ã“ã“ã§ã¯ç°¡ç•¥åŒ–ã®ãŸã‚ã«å˜ç´”ãªå››è§’å½¢ã‚’æç”»
        self.context.set_fill_style_str("#3333AA");  // ç›¸æ‰‹ã‚«ãƒ¼ãƒ‰ã®èƒŒæ™¯è‰²
        
        // ç›¸æ‰‹ã®æ‰‹æœ­ï¼ˆã‚«ãƒ¼ãƒ‰ã®è£é¢ï¼‰
        for i in 0..5 {
            let x = 100.0 + (i as f64) * 80.0;
            let y = 100.0;
            
            // ã‚«ãƒ¼ãƒ‰ã®è£é¢ã‚’æç”»
            self.context.fill_rect(x, y, 70.0, 100.0);
            
            // ã‚«ãƒ¼ãƒ‰ã®æ ç·š
            self.context.stroke_rect(x, y, 70.0, 100.0);
        }
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹æœ­ï¼ˆè¡¨å‘ãï¼‰
        // å®Ÿéš›ã®ã‚²ãƒ¼ãƒ ã§ã¯ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦æç”»
        self.context.set_fill_style_str("#FFDD33");  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚«ãƒ¼ãƒ‰ã®èƒŒæ™¯è‰²
        
        for i in 0..5 {
            let x = 100.0 + (i as f64) * 80.0;
            let y = (self.canvas.height() - 150) as f64;
            
            // ã‚«ãƒ¼ãƒ‰ã‚’æç”»
            self.context.fill_rect(x, y, 70.0, 100.0);
            
            // ã‚«ãƒ¼ãƒ‰ã®æ ç·š
            self.context.stroke_rect(x, y, 70.0, 100.0);
            
            // ã‚«ãƒ¼ãƒ‰ã®å€¤ã‚„ãƒ†ã‚­ã‚¹ãƒˆã‚’æç”»
            self.context.set_fill_style_str("#000000");
            self.context.set_font("14px Arial");
            self.context.set_text_align("center");
            
            // ã‚«ãƒ¼ãƒ‰ç•ªå·
            let _ = self.context.fill_text(
                &format!("ã‚«ãƒ¼ãƒ‰{}", i+1),
                x + 35.0,
                y + 20.0,
            );
            
            // ã‚«ãƒ¼ãƒ‰ã®åŠ¹æœãƒ†ã‚­ã‚¹ãƒˆ
            self.context.set_font("10px Arial");
            let _ = self.context.fill_text(
                "åŠ¹æœãƒ†ã‚­ã‚¹ãƒˆ",
                x + 35.0,
                y + 60.0,
            );
        }
        
        // æ“ä½œã‚¬ã‚¤ãƒ‰
        self.context.set_font("16px Arial");
        self.context.set_fill_style_str("#FFFFFF");
        self.context.set_text_align("center");
        let _ = self.context.fill_text(
            "ã‚¯ãƒªãƒƒã‚¯: ã‚«ãƒ¼ãƒ‰é¸æŠ  Enter: ã‚«ãƒ¼ãƒ‰ãƒ—ãƒ¬ã‚¤  Esc: ãƒ¡ãƒ‹ãƒ¥ãƒ¼",
            (self.canvas.width() / 2) as f64,
            (self.canvas.height() - 20) as f64,
        );
        
        Ok(())
    }

    /// ãƒãƒ¼ã‚ºç”»é¢ã®æç”»å‡¦ç†
    /// 
    /// ã‚²ãƒ¼ãƒ ãŒä¸€æ™‚åœæ­¢ã—ã¦ã„ã‚‹é–“ã®ç”»é¢ã‚’æç”»ã—ã¾ã™ã€‚
    /// ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠã‚„è¨­å®šå¤‰æ›´ãªã©ã®UIè¦ç´ ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
    fn render_paused(&self) -> Result<(), JsValue> {
        // ã¾ãšç¾åœ¨ã®ã‚²ãƒ¼ãƒ ç”»é¢ã‚’åŠé€æ˜ã§è¡¨ç¤ºï¼ˆèƒŒæ™¯ã¨ã—ã¦ï¼‰
        self.render_playing()?;
        
        // åŠé€æ˜ã®é»’ã„ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’æç”»
        self.context.set_fill_style_str("rgba(0, 0, 0, 0.7)");
        self.context.fill_rect(
            0.0,
            0.0,
            self.canvas.width() as f64,
            self.canvas.height() as f64,
        );
        
        // ãƒãƒ¼ã‚ºãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚¿ã‚¤ãƒˆãƒ«
        self.context.set_font("36px Arial");
        self.context.set_fill_style_str("#FFFFFF");
        self.context.set_text_align("center");
        let _ = self.context.fill_text(
            "ã‚²ãƒ¼ãƒ ä¸€æ™‚åœæ­¢",
            (self.canvas.width() / 2) as f64,
            120.0,
        );
        
        // ãƒãƒ¼ã‚ºãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®é¸æŠé …ç›®
        self.context.set_font("24px Arial");
        let menu_items = ["ã‚²ãƒ¼ãƒ ã«æˆ»ã‚‹", "ã‚ªãƒ—ã‚·ãƒ§ãƒ³", "ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†"];
        
        for (i, item) in menu_items.iter().enumerate() {
            let y = 200.0 + (i as f64) * 50.0;
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®èƒŒæ™¯
            self.context.set_fill_style_str("#223366");
            self.context.fill_rect(
                (self.canvas.width() as f64 / 2.0) - 150.0,
                y - 20.0,
                300.0,
                40.0,
            );
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®ãƒ†ã‚­ã‚¹ãƒˆ
            self.context.set_fill_style_str("#FFFFFF");
            let _ = self.context.fill_text(
                item,
                (self.canvas.width() / 2) as f64,
                y,
            );
        }
        
        // æ“ä½œèª¬æ˜
        self.context.set_font("16px Arial");
        self.context.set_fill_style_str("#CCCCCC");
        let _ = self.context.fill_text(
            "â†‘â†“: é¸æŠ  Enter: æ±ºå®š  Esc: ã‚²ãƒ¼ãƒ ã«æˆ»ã‚‹",
            (self.canvas.width() / 2) as f64,
            (self.canvas.height() - 50) as f64,
        );
        
        Ok(())
    }

    /// ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ã®æç”»å‡¦ç†
    /// 
    /// ã‚²ãƒ¼ãƒ ãŒçµ‚äº†ã—ãŸå¾Œã®çµæœç”»é¢ã‚’æç”»ã—ã¾ã™ã€‚
    /// å‹æ•—çµæœã€ã‚¹ã‚³ã‚¢ã€çµ±è¨ˆæƒ…å ±ãªã©ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
    fn render_game_over(&self) -> Result<(), JsValue> {
        // èƒŒæ™¯ã‚’æ¿ƒã„è‰²ã§æç”»
        self.context.set_fill_style_str("#111133");
        self.context.fill_rect(
            0.0,
            0.0,
            self.canvas.width() as f64,
            self.canvas.height() as f64,
        );
        
        // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã®ã‚¿ã‚¤ãƒˆãƒ«
        self.context.set_font("48px Arial");
        self.context.set_fill_style_str("#FFCC00");  // é‡‘è‰²
        self.context.set_text_align("center");
        let _ = self.context.fill_text(
            "ã‚²ãƒ¼ãƒ çµ‚äº†",
            (self.canvas.width() / 2) as f64,
            100.0,
        );
        
        // å‹æ•—çµæœ
        self.context.set_font("36px Arial");
        self.context.set_fill_style_str("#FFFFFF");
        let _ = self.context.fill_text(
            "ã‚ãªãŸã®å‹åˆ©ï¼",  // ã¾ãŸã¯ "ã‚ãªãŸã®æ•—åŒ—..."
            (self.canvas.width() / 2) as f64,
            180.0,
        );
        
        // ã‚²ãƒ¼ãƒ çµ±è¨ˆæƒ…å ±
        self.context.set_font("24px Arial");
        let stats = [
            "ãƒ—ãƒ¬ã‚¤æ™‚é–“: 5åˆ†23ç§’",
            "ä½¿ç”¨ã‚«ãƒ¼ãƒ‰æ•°: 12æš",
            "æœ€å¤§ã‚³ãƒ³ãƒœ: 3é€£é–",
            "ã‚¹ã‚³ã‚¢: 2850ç‚¹",
        ];
        
        for (i, stat) in stats.iter().enumerate() {
            let y = 250.0 + (i as f64) * 40.0;
            let _ = self.context.fill_text(
                stat,
                (self.canvas.width() / 2) as f64,
                y,
            );
        }
        
        // å†æˆ¦/çµ‚äº†ãƒœã‚¿ãƒ³
        self.context.set_font("24px Arial");
        
        // å†æˆ¦ãƒœã‚¿ãƒ³
        self.context.set_fill_style_str("#2255AA");
        self.context.fill_rect(
            (self.canvas.width() as f64 / 2.0) - 200.0,
            350.0,
            180.0,
            50.0,
        );
        
        self.context.set_fill_style_str("#FFFFFF");
        let _ = self.context.fill_text(
            "ã‚‚ã†ä¸€åº¦",
            (self.canvas.width() as f64 / 2.0) - 110.0,
            380.0,
        );
        
        // çµ‚äº†ãƒœã‚¿ãƒ³
        self.context.set_fill_style_str("#AA2255");
        self.context.fill_rect(
            (self.canvas.width() as f64 / 2.0) + 20.0,
            350.0,
            180.0,
            50.0,
        );
        
        self.context.set_fill_style_str("#FFFFFF");
        let _ = self.context.fill_text(
            "ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸",
            (self.canvas.width() as f64 / 2.0) + 110.0,
            380.0,
        );
        
        // æ“ä½œèª¬æ˜
        self.context.set_font("16px Arial");
        self.context.set_fill_style_str("#CCCCCC");
        let _ = self.context.fill_text(
            "Enter: å†æˆ¦  Esc: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹",
            (self.canvas.width() / 2) as f64,
            (self.canvas.height() - 50) as f64,
        );
        
        Ok(())
    }

    // ã‚­ãƒ¼å…¥åŠ›å‡¦ç†
    // -----------
    
    /// ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢ã§ã®ã‚­ãƒ¼å…¥åŠ›å‡¦ç†
    /// 
    /// ã©ã®ã‚­ãƒ¼ãŒæŠ¼ã•ã‚Œã¦ã‚‚ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«é·ç§»ã—ã¾ã™ã€‚
    fn handle_splash_key(&mut self, _key_code: u32) -> Result<(), JsValue> {
        log::info!("ğŸ”‘ ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢ã§ã‚­ãƒ¼å…¥åŠ›: {}", _key_code);
        
        // ã©ã®ã‚­ãƒ¼ã§ã‚‚ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ç§»å‹•
        self.current_state = GameStateType::MainMenu;
        log::info!("ğŸ”„ çŠ¶æ…‹é·ç§»: ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ â†’ ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼");
        
        Ok(())
    }

    /// ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§ã®ã‚­ãƒ¼å…¥åŠ›å‡¦ç†
    /// 
    /// ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®é¸æŠã‚„æ±ºå®šã‚’å‡¦ç†ã—ã¾ã™ã€‚
    /// - ä¸Šä¸‹ã‚­ãƒ¼: é¸æŠé …ç›®ã®ç§»å‹•
    /// - Enter: é¸æŠé …ç›®ã®æ±ºå®š
    /// - Esc: å‰ã®ç”»é¢ã«æˆ»ã‚‹
    fn handle_main_menu_key(&mut self, key_code: u32) -> Result<(), JsValue> {
        log::info!("ğŸ”‘ ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§ã‚­ãƒ¼å…¥åŠ›: {}", key_code);
        
        match key_code {
            // Enterã‚­ãƒ¼
            13 => {
                // é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã«å¿œã˜ãŸå‡¦ç†
                // ä¾‹: ã€Œãƒ—ãƒ¬ã‚¤é–‹å§‹ã€ãªã‚‰ã‚²ãƒ¼ãƒ é–‹å§‹
                self.current_state = GameStateType::Playing;
                log::info!("ğŸ”„ çŠ¶æ…‹é·ç§»: ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â†’ ãƒ—ãƒ¬ã‚¤ä¸­");
            },
            // Escã‚­ãƒ¼
            27 => {
                // ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢ã«æˆ»ã‚‹
                self.current_state = GameStateType::Splash;
                log::info!("ğŸ”„ çŠ¶æ…‹é·ç§»: ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â†’ ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥");
            },
            // ä¸Šã‚­ãƒ¼
            38 => {
                // é¸æŠé …ç›®ã‚’ä¸Šã«ç§»å‹•
                log::info!("â¬†ï¸ ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠã‚’ä¸Šã«ç§»å‹•");
                // self.selected_menu_index = (self.selected_menu_index + self.menu_items.len() - 1) % self.menu_items.len();
            },
            // ä¸‹ã‚­ãƒ¼
            40 => {
                // é¸æŠé …ç›®ã‚’ä¸‹ã«ç§»å‹•
                log::info!("â¬‡ï¸ ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠã‚’ä¸‹ã«ç§»å‹•");
                // self.selected_menu_index = (self.selected_menu_index + 1) % self.menu_items.len();
            },
            _ => {
                log::info!("âš ï¸ æœªå‡¦ç†ã®ã‚­ãƒ¼å…¥åŠ›: {}", key_code);
            }
        }
        
        Ok(())
    }

    /// ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ä¸­ã®ã‚­ãƒ¼å…¥åŠ›å‡¦ç†
    /// 
    /// ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ã§ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œã‚’å‡¦ç†ã—ã¾ã™ã€‚
    /// - æ–¹å‘ã‚­ãƒ¼: ã‚«ãƒ¼ãƒ‰ã®é¸æŠ
    /// - Enter: ã‚«ãƒ¼ãƒ‰ã®ãƒ—ãƒ¬ã‚¤
    /// - Esc: ãƒãƒ¼ã‚ºãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã
    fn handle_playing_key(&mut self, key_code: u32) -> Result<(), JsValue> {
        log::info!("ğŸ”‘ ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ä¸­ã®ã‚­ãƒ¼å…¥åŠ›: {}", key_code);
        
        match key_code {
            // Enterã‚­ãƒ¼ï¼ˆã‚«ãƒ¼ãƒ‰ãƒ—ãƒ¬ã‚¤ã‚„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç¢ºå®šï¼‰
            13 => {
                log::info!("ğŸƒ é¸æŠã‚«ãƒ¼ãƒ‰ã‚’ãƒ—ãƒ¬ã‚¤");
                // ã‚«ãƒ¼ãƒ‰ãƒ—ãƒ¬ã‚¤ã®ãƒ­ã‚¸ãƒƒã‚¯
            },
            // Escã‚­ãƒ¼ï¼ˆãƒãƒ¼ã‚ºãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ãï¼‰
            27 => {
                self.current_state = GameStateType::Paused;
                log::info!("ğŸ”„ çŠ¶æ…‹é·ç§»: ãƒ—ãƒ¬ã‚¤ä¸­ â†’ ãƒãƒ¼ã‚º");
            },
            // ãã®ä»–ã®ã‚­ãƒ¼å…¥åŠ›ï¼ˆã‚«ãƒ¼ãƒ‰é¸æŠãªã©ï¼‰
            _ => {
                log::info!("âš ï¸ æœªå‡¦ç†ã®ã‚­ãƒ¼å…¥åŠ›: {}", key_code);
            }
        }
        
        Ok(())
    }

    /// ãƒãƒ¼ã‚ºä¸­ã®ã‚­ãƒ¼å…¥åŠ›å‡¦ç†
    /// 
    /// ãƒãƒ¼ã‚ºãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§ã®æ“ä½œã‚’å‡¦ç†ã—ã¾ã™ã€‚
    /// - ä¸Šä¸‹ã‚­ãƒ¼: ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®é¸æŠ
    /// - Enter: é¸æŠé …ç›®ã®æ±ºå®š
    /// - Esc: ã‚²ãƒ¼ãƒ ã«æˆ»ã‚‹
    fn handle_paused_key(&mut self, key_code: u32) -> Result<(), JsValue> {
        log::info!("ğŸ”‘ ãƒãƒ¼ã‚ºä¸­ã®ã‚­ãƒ¼å…¥åŠ›: {}", key_code);
        
        match key_code {
            // Enterã‚­ãƒ¼ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®æ±ºå®šï¼‰
            13 => {
                // é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã«å¿œã˜ãŸå‡¦ç†
                // ä¾‹: ã€Œã‚²ãƒ¼ãƒ ã«æˆ»ã‚‹ã€ãªã‚‰ãƒ—ãƒ¬ã‚¤çŠ¶æ…‹ã«æˆ»ã‚‹
                log::info!("âœ… ãƒãƒ¼ã‚ºãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®é …ç›®ã‚’é¸æŠ");
                self.current_state = GameStateType::Playing;
                log::info!("ğŸ”„ çŠ¶æ…‹é·ç§»: ãƒãƒ¼ã‚º â†’ ãƒ—ãƒ¬ã‚¤ä¸­");
            },
            // Escã‚­ãƒ¼ï¼ˆã‚²ãƒ¼ãƒ ã«æˆ»ã‚‹ï¼‰
            27 => {
                self.current_state = GameStateType::Playing;
                log::info!("ğŸ”„ çŠ¶æ…‹é·ç§»: ãƒãƒ¼ã‚º â†’ ãƒ—ãƒ¬ã‚¤ä¸­");
            },
            // ãã®ä»–ã®ã‚­ãƒ¼æ“ä½œ
            _ => {
                log::info!("âš ï¸ æœªå‡¦ç†ã®ã‚­ãƒ¼å…¥åŠ›: {}", key_code);
            }
        }
        
        Ok(())
    }

    /// ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚ã®ã‚­ãƒ¼å…¥åŠ›å‡¦ç†
    /// 
    /// ã‚²ãƒ¼ãƒ çµ‚äº†ç”»é¢ã§ã®æ“ä½œã‚’å‡¦ç†ã—ã¾ã™ã€‚
    /// - Enter: å†æˆ¦
    /// - Esc: ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
    fn handle_game_over_key(&mut self, key_code: u32) -> Result<(), JsValue> {
        log::info!("ğŸ”‘ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚ã®ã‚­ãƒ¼å…¥åŠ›: {}", key_code);
        
        match key_code {
            // Enterã‚­ãƒ¼ï¼ˆå†æˆ¦ï¼‰
            13 => {
                // æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹
                self.current_state = GameStateType::Playing;
                log::info!("ğŸ”„ çŠ¶æ…‹é·ç§»: ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ â†’ ãƒ—ãƒ¬ã‚¤ä¸­ï¼ˆå†æˆ¦ï¼‰");
            },
            // Escã‚­ãƒ¼ï¼ˆãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹ï¼‰
            27 => {
                self.current_state = GameStateType::MainMenu;
                log::info!("ğŸ”„ çŠ¶æ…‹é·ç§»: ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ â†’ ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼");
            },
            // ãã®ä»–ã®ã‚­ãƒ¼æ“ä½œ
            _ => {
                log::info!("âš ï¸ æœªå‡¦ç†ã®ã‚­ãƒ¼å…¥åŠ›: {}", key_code);
            }
        }
        
        Ok(())
    }

    // ãƒã‚¦ã‚¹å…¥åŠ›å‡¦ç†
    // -------------
    
    /// ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢ã§ã®ãƒã‚¦ã‚¹å…¥åŠ›å‡¦ç†
    /// 
    /// ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«é·ç§»ã—ã¾ã™ã€‚
    fn handle_splash_mouse(&mut self, _x: f32, _y: f32, _button: u8) -> Result<(), JsValue> {
        log::info!("ğŸ–±ï¸ ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢ã§ãƒã‚¦ã‚¹ã‚¯ãƒªãƒƒã‚¯: åº§æ¨™({}, {}), ãƒœã‚¿ãƒ³{}", _x, _y, _button);
        
        // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ç§»å‹•
        self.current_state = GameStateType::MainMenu;
        log::info!("ğŸ”„ çŠ¶æ…‹é·ç§»: ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ â†’ ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼");
        
        Ok(())
    }

    /// ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã§ã®ãƒã‚¦ã‚¹å…¥åŠ›å‡¦ç†
    /// 
    /// ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®ã‚¯ãƒªãƒƒã‚¯ã‚’å‡¦ç†ã—ã¾ã™ã€‚
    /// å„ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®é ˜åŸŸã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€å¯¾å¿œã™ã‚‹æ©Ÿèƒ½ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
    fn handle_main_menu_mouse(&mut self, _x: f32, _y: f32, _button: u8) -> Result<(), JsValue> {
        log::info!("ğŸ–±ï¸ ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§ãƒã‚¦ã‚¹ã‚¯ãƒªãƒƒã‚¯: åº§æ¨™({}, {}), ãƒœã‚¿ãƒ³{}", _x, _y, _button);
        
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®Yåº§æ¨™ç¯„å›²ã‚’ãƒã‚§ãƒƒã‚¯
        // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸåº§æ¨™ãŒå„ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®ç¯„å›²å†…ã‹ã©ã†ã‹ã‚’ç¢ºèª
        
        // ä¾‹: ãƒ—ãƒ¬ã‚¤é–‹å§‹ãƒœã‚¿ãƒ³é ˜åŸŸã®åˆ¤å®š
        let play_button_y = 150.0;
        if (_y >= play_button_y - 20.0 && _y <= play_button_y + 20.0) {
            // ãƒ—ãƒ¬ã‚¤é–‹å§‹ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸ
            log::info!("âœ… ãƒ—ãƒ¬ã‚¤é–‹å§‹ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");
            self.current_state = GameStateType::Playing;
            log::info!("ğŸ”„ çŠ¶æ…‹é·ç§»: ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â†’ ãƒ—ãƒ¬ã‚¤ä¸­");
            return Ok(());
        }
        
        // ä¾‹: ãã®ä»–ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã®åˆ¤å®š
        // ...
        
        // ã‚¯ãƒªãƒƒã‚¯ãŒæœ‰åŠ¹ãªUIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä¸Šã§ãªã‹ã£ãŸå ´åˆ
        log::info!("âš ï¸ æœ‰åŠ¹ãªãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ");
        Ok(())
    }

    /// ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ä¸­ã®ãƒã‚¦ã‚¹å…¥åŠ›å‡¦ç†
    /// 
    /// ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ã®ãƒ—ãƒ¬ã‚¤ä¸­ã€ãƒã‚¦ã‚¹ã‚¯ãƒªãƒƒã‚¯ã§ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ãŸã‚Š
    /// ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ãŸã‚Šã™ã‚‹å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚
    fn handle_playing_mouse(&mut self, _x: f32, _y: f32, _button: u8) -> Result<(), JsValue> {
        log::info!("ğŸ–±ï¸ ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ä¸­ã®ãƒã‚¦ã‚¹ã‚¯ãƒªãƒƒã‚¯: åº§æ¨™({}, {}), ãƒœã‚¿ãƒ³{}", _x, _y, _button);
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹æœ­é ˜åŸŸã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‹ãƒã‚§ãƒƒã‚¯
        let hand_cards_y = self.canvas.height() as f32 - 150.0;
        if (_y >= hand_cards_y && _y <= hand_cards_y + 100.0) {
            // Xåº§æ¨™ã‹ã‚‰ä½•ç•ªç›®ã®ã‚«ãƒ¼ãƒ‰ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‹ã‚’è¨ˆç®—
            let card_width = 80.0;
            let card_start_x = 100.0;
            
            // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨ˆç®—
            let card_index = ((_x - card_start_x) / card_width) as usize;
            
            // æœ‰åŠ¹ãªã‚«ãƒ¼ãƒ‰ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆ0ã€œ4ã®ç¯„å›²ï¼‰
            if card_index < 5 {
                log::info!("ğŸƒ ã‚«ãƒ¼ãƒ‰ {} ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ", card_index + 1);
                // ã‚«ãƒ¼ãƒ‰é¸æŠã‚„ãƒ—ãƒ¬ã‚¤ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«å®Ÿè£…
                // ä¾‹: self.select_card(card_index);
            }
        }
        
        // å ´ã®ã‚«ãƒ¼ãƒ‰ã‚„ç›¸æ‰‹ã®ã‚«ãƒ¼ãƒ‰ãªã©ã€ä»–ã®é ˜åŸŸã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ã‚‚ã“ã“ã«å®Ÿè£…
        
        Ok(())
    }

    /// ãƒãƒ¼ã‚ºç”»é¢ã§ã®ãƒã‚¦ã‚¹å…¥åŠ›å‡¦ç†
    /// 
    /// ãƒãƒ¼ã‚ºãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®é …ç›®é¸æŠã‚’å‡¦ç†ã—ã¾ã™ã€‚
    fn handle_paused_mouse(&mut self, _x: f32, _y: f32, _button: u8) -> Result<(), JsValue> {
        log::info!("ğŸ–±ï¸ ãƒãƒ¼ã‚ºç”»é¢ã§ã®ãƒã‚¦ã‚¹ã‚¯ãƒªãƒƒã‚¯: åº§æ¨™({}, {}), ãƒœã‚¿ãƒ³{}", _x, _y, _button);
        
        // ãƒãƒ¼ã‚ºãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®Yåº§æ¨™ç¯„å›²ã‚’ãƒã‚§ãƒƒã‚¯
        let resume_button_y = 200.0;
        if (_y >= resume_button_y - 20.0 && _y <= resume_button_y + 20.0) {
            // ã€Œã‚²ãƒ¼ãƒ ã«æˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸ
            log::info!("âœ… ã‚²ãƒ¼ãƒ ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");
            self.current_state = GameStateType::Playing;
            log::info!("ğŸ”„ çŠ¶æ…‹é·ç§»: ãƒãƒ¼ã‚º â†’ ãƒ—ãƒ¬ã‚¤ä¸­");
            return Ok(());
        }
        
        // ä»–ã®ãƒãƒ¼ã‚ºãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®å‡¦ç†
        // ...
        
        Ok(())
    }

    /// ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ã§ã®ãƒã‚¦ã‚¹å…¥åŠ›å‡¦ç†
    /// 
    /// çµæœç”»é¢ã§ã®ã€Œå†æˆ¦ã€ã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸ã€ãªã©ã®ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚’å‡¦ç†ã—ã¾ã™ã€‚
    fn handle_game_over_mouse(&mut self, _x: f32, _y: f32, _button: u8) -> Result<(), JsValue> {
        log::info!("ğŸ–±ï¸ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ã§ã®ãƒã‚¦ã‚¹ã‚¯ãƒªãƒƒã‚¯: åº§æ¨™({}, {}), ãƒœã‚¿ãƒ³{}", _x, _y, _button);
        
        // ã€Œã‚‚ã†ä¸€åº¦ã€ãƒœã‚¿ãƒ³ã®åˆ¤å®š
        let retry_button_x = (self.canvas.width() as f32 / 2.0) - 110.0;
        let retry_button_y = 380.0;
        
        if (_x >= retry_button_x - 90.0 && _x <= retry_button_x + 90.0 &&
            _y >= retry_button_y - 25.0 && _y <= retry_button_y + 25.0) {
            // ã€Œã‚‚ã†ä¸€åº¦ã€ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸ
            log::info!("âœ… ã‚‚ã†ä¸€åº¦ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");
            self.current_state = GameStateType::Playing;
            log::info!("ğŸ”„ çŠ¶æ…‹é·ç§»: ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ â†’ ãƒ—ãƒ¬ã‚¤ä¸­ï¼ˆå†æˆ¦ï¼‰");
            return Ok(());
        }
        
        // ã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸ã€ãƒœã‚¿ãƒ³ã®åˆ¤å®š
        let menu_button_x = (self.canvas.width() as f32 / 2.0) + 110.0;
        let menu_button_y = 380.0;
        
        if (_x >= menu_button_x - 90.0 && _x <= menu_button_x + 90.0 &&
            _y >= menu_button_y - 25.0 && _y <= menu_button_y + 25.0) {
            // ã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸ã€ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸ
            log::info!("âœ… ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");
            self.current_state = GameStateType::MainMenu;
            log::info!("ğŸ”„ çŠ¶æ…‹é·ç§»: ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ â†’ ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼");
            return Ok(());
        }
        
        Ok(())
    }
}

// ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
// -------------
#[cfg(test)]
mod tests {
    use super::*;
    
    /// GameStateã®ä½œæˆãƒ†ã‚¹ãƒˆ
    /// 
    /// ã“ã®é–¢æ•°ã¯å®Ÿéš›ã®ãƒ†ã‚¹ãƒˆã§ã¯ãªãã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒé€šã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹å½¹å‰²ã§ã™ã€‚
    /// Webãƒ–ãƒ©ã‚¦ã‚¶ã®APIã‚’ä½¿ã†ãŸã‚ã€å®Ÿéš›ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¯ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ã®ã¿å¯èƒ½ã§ã™ã€‚
    #[test]
    fn test_game_state_creation() {
        // ã“ã®ãƒ†ã‚¹ãƒˆã¯å®Ÿéš›ã«ã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ï¼ˆHtmlCanvasElementãŒå¿…è¦ãªãŸã‚ï¼‰
        // ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ãƒã‚§ãƒƒã‚¯ã®ã¿ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™
    }
} 